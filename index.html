<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>JS Experiments</title>
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Arimo" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Cabin" />
    <style>
      body{
        margin: auto 0;
        background: #fff;
        height: 100%;
        font-family: Cabin;
      }

      .header-cont{
        font-size: 15px;
        background-color: #084a58;
        height: 100px;
        position: relative;
        top: -22px;
        display: block;
        margin: auto 0;
      }

      header{
        display: block;
        padding-top: 20px;
      }

      h1{
        padding-left: 40px;
        color: #fff;
        font-size: 1.8em;
        font-weight: 100;
        font-family: sans-serif;
      }

      .tool-cont{
        padding-left: 23%;
        width:100%;
        height: 500px;
        /*border-bottom: 1px solid #000;*/
      }

      .canvas-cont{
        float: left;
        height: 100%;
        width: 50%;
        /*position: relative;*/
        /*border-right: 2px dashed #084a58;*/
      }

      .result-cont{
        float: right;
        height: 100%;
        width: 50%;
      }

      .crop-transition{
        transform: rotate(45deg);
        display: inline-block;
        background: white;
        color: #084a58;
        margin: 0px 14px;
      }

      .btn-cont{
        padding-top: 20px;
        padding-left: 40px;
      }

      button{
        width: 70px;
        height: 40px;
        background: #03a9f4;
        border: 0;
        color: white;
        border-radius: 4px;
        font-size: 14px;
        outline: none;
      }

      #crop-canvas{
        display: none;
      }

      .placeholder-div{
        position: relative;
        box-shadow: 2px -2px 10px 2px rgb(158, 158, 158);
        margin-top: 40px;
        margin-left: 40px;
        width: 568px;
        text-align: center;
        height: 320px;
        border: 2px solid black;
      }

      .placeholder-div p{
        font-family: sans-serif;
        color: grey;
        font-size: 14px;
      }

      .sample-img{
        width: 568px;
        height: 320px;
      }

    .crop-select {
        position: absolute;
        resize: both;
        width: 100px;
        height: 100px;
        overflow: auto;
        background: transparent;
        border: 2px dashed #fff;
        background: rgba(0, 0, 0, 0.23);
        top: 300px;
        left: 400px;
    }

    #filter-canvas{
      z-index: 10;
      position: absolute;
      display: none;
    }

    </style>
</head>

<body>
  <div class="header-cont">
    <header>
      <h1>Image cr<span class="crop-transition heading-span">op</span> with canvas</h1>
    </header>
  </div>
  <div class="tool-cont">
    <div class="canvas-cont">
      <div class="placeholder-div">
        <!-- <img src="images/placeholder.png" /> -->
        <img src="images/image1.jpg" class="sample-img" />
        <!-- <p>Upload an image or drag and drop one from your system or use a sample ;)</p> -->
        <canvas id="filter-canvas">
          An alternative text describing what your canvas displays.
        </canvas>
        <canvas id="crop-canvas" width="568" height="320">
          An alternative text describing what your canvas displays.
        </canvas>
      </div>
      <div class="btn-cont effect-toolbar">
        <button class="crop-btn">Crop</button>
        <button class="upload-btn">Upload</button>
        <button class="crop-done">Done</button>
        <button class="crop-btn">G/W</button>
        <button class="crop-btn">Blue</button>
      </div>
    </div>
    <!-- <div class="result-cont">
    </div> -->
  </div>


  <script>
    var _document = document;
    var cropTopOffset;
    var cropLeftOffset;
    var cropCanvas = _document.getElementById('crop-canvas');
    var cropContext = cropCanvas.getContext("2d");
    var cropImage = new Image();
    /***top header style*****/
    var heading = _document.getElementsByTagName("h1")[0];
    heading.addEventListener("mouseover", function(){
      var transitionSpan = _document.getElementsByClassName("heading-span")[0];
      transitionSpan.classList.remove('crop-transition');
    });
    heading.addEventListener("mouseout", function(){
      var transitionSpan = _document.getElementsByClassName("heading-span")[0];
      transitionSpan.classList.add('crop-transition');
    });
    /**************/

    var cropButton = _document.querySelector(".crop-btn");

    cropButton.addEventListener("click", createCropArea, false);

    function createCropArea(e){
      _document.querySelector(".sample-img").style.display = "none";

      var cropContext = cropCanvas.getContext("2d");
      var sampleImage  = new Image();
      sampleImage.onload = function() {
          //context2.drawImage(img, 0, 0, 400, 300, 20, 20, 400, 400);
          cropContext.drawImage(sampleImage, 0, 0, sampleImage.width, sampleImage.height, 0, 0, 568, 320);
          var imageURI = cropCanvas.toDataURL("image/png");
          cropImage.src = imageURI;
          cropCanvas.style.display = "block";
      }
      sampleImage.src = "images/image1.jpg";
      if (_document.getElementsByClassName('crop-select')[0]) {
          _document.getElementsByClassName('crop-select')[0].remove();
      }
      var left = e.clientX;
      var top = e.clientY;
      var newDiv = _document.createElement('div');
      canvasCont = _document.querySelector(".canvas-cont");
      canvasCont.appendChild(newDiv);
      newDiv.classList.add('crop-select');
      newDiv.setAttribute("draggable", "true");
      cropTopOffset = top;
      cropLeftOffset = left;
      document.getElementsByClassName("crop-select")[0].addEventListener("dragstart", function(e) {
          e.stopPropagation();
          deltaX = e.clientX - document.getElementsByClassName("crop-select")[0].getBoundingClientRect().left;
          deltaY = e.clientY - document.getElementsByClassName("crop-select")[0].getBoundingClientRect().top;
          console.log(deltaX, deltaY);
          dragSrcEl = this;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', this.innerHTML);
      }, false);

      document.querySelector(".crop-select").addEventListener("dragover", function(e){
        e.preventDefault();
      }, false);

      document.querySelector(".crop-select").addEventListener("drop", function(e){
          e.preventDefault();
          console.log("drop fired in crop select");
          if (e.stopPropagation) {
           e.stopPropagation(); // Stops some browsers from redirecting.
          }
          var newDiv = document.querySelector(".crop-select");
          var left = e.clientX;
          var top = e.clientY;
          newDiv.style.top = top + "px";
          newDiv.style.left = left + "px";
          //this.innerHTML = e.dataTransfer.getData('text/html');
         return false;
      }, false);
    };


    cropCanvas.addEventListener("drop", function(e){
        e.preventDefault();
        console.log("drop fired in canvas");
        if (e.stopPropagation) {
         e.stopPropagation(); // Stops some browsers from redirecting.
        }
        var newDiv = _document.querySelector(".crop-select");
        var position = newDiv.getBoundingClientRect();
        var cropWidth = newDiv.offsetWidth;
        var cropHeight = newDiv.offsetHeight;
        var finalLeft = position.left
        var finalTop = position.top
        var left = e.pageX - deltaX//- position.left;
        var top = e.pageY - deltaY//- position.top;
        newDiv.style.top = top + "px";
        newDiv.style.left = left + "px";
        //this.innerHTML = e.dataTransfer.getData('text/html');
       return false;
    }, false);

    cropCanvas.addEventListener("dragover", function(e){
      e.preventDefault();
    }, false);

    cropCanvas.addEventListener("dragover", function(e){
      e.preventDefault();
    }, false);

    var cropDoneBtn = _document.querySelector('.crop-done');
    cropDoneBtn.addEventListener('click', function(){
      console.log('done clicked');
      var filterCanvas = document.querySelector('#filter-canvas');
      var filterContext = filterCanvas.getContext('2d');

      var cropDiv = _document.querySelector('.crop-select');
      cropWidth = cropDiv.offsetWidth;
      cropHeight = cropDiv.offsetHeight;
      //cropDiv.style.display = 'none';
      var newDiv = _document.querySelector(".crop-select");
      var placeholderDivCor = _document.querySelector(".placeholder-div").getBoundingClientRect();
      var position = newDiv.getBoundingClientRect();
      console.log(position);
      console.log(placeholderDivCor);
      cropDiv.style.display = 'none';
      var cropLeftOffset =  left = position.left - placeholderDivCor.left; //e.clientX;
      var cropTopOffset = top = position.top - placeholderDivCor.top; //e.clientY;
      console.log(cropHeight + "  " + cropWidth + " " + cropTopOffset + " " + cropLeftOffset);

      //cropCanvas.style.display = 'none';

      filterCanvas.style.height = cropHeight;
      filterCanvas.style.width = cropWidth;
      filterCanvas.style.display = 'block';
      filterContext.drawImage(cropImage, cropLeftOffset, cropTopOffset, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
    }, false);
  </script>
</body>
</html>
